name: CD - Deploy Application

on:
  release:
    types: [published]
  workflow_dispatch:  # Ğ”Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2423 course.prafdin.ru >> ~/.ssh/known_hosts
    
    - name: Deploy to server via SSH
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        ssh -p 2423 lilia@course.prafdin.ru << ENDSSH
          cd /home/lilia/my-app
          echo "Current directory: \$(pwd)"
          echo "Pulling latest changes..."
          git pull "https://\$GITHUB_TOKEN@github.com/LiliaASt/catty-reminders-app.git" github-actions
          echo "Installing dependencies..."
          python3 -m venv venv
          ./venv/bin/pip install -r requirements.txt
          ./venv/bin/playwright install --with-deps chromium
          echo "Stopping previous application..."
          pkill -f "uvicorn.*8181" || true
          echo "Starting new application..."
          nohup ./venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8181 > app.log 2>&1 &
          echo "âœ… Deployment completed!"
        ENDSSH
    
    - name: Verify deployment
      run: |
        echo "ğŸš€ Application deployed successfully!"
        echo "ğŸ“… Deployment time: $(date)"
        echo "ğŸŒ Application URL: http://app.ascatryan.course.prafdin.ru"
        echo "ğŸ”§ SSH port used: 2423"
